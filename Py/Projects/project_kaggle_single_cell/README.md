## Проект открытые проблемы - одноклеточный анализ (Kaggle competitions)

в рамках обучения профессии Data Science от SkillFactory

## Предсказание реакции клеток на возмущения малых молекул лекарств:

* [Короткое решение (на submit)]()
* [Развернутое решение (на площадку skillFactory)]()

***
***

## Содержание

[1. Постановка проблемы](#проблема)

[2. Метрика](#ипользуемая-метрика)

[3. Критерии оценки](#критерии-оценки)

[4. Обзор данных](#обзор-данных)

[5. Описание данных](#описание-данных)

[6. Итоги](#итоги)


## Проблема:

Человеческая биология может быть сложной, отчасти из-за функции и взаимодействия приблизительно **37 триллионов** клеток тела, которые организованы в ткани, органы и системы. 

Однако последние достижения в одноклеточных технологиях позволили получить беспрецедентное представление о функции клеток и тканей на уровне ДНК, РНК и белков. 

Тем не менее, использование одноклеточных методов для разработки лекарственных средств требует **картирования причинно-следственных связей** между химическими возмущениями и последующим воздействием на состояние клеток. 

Эти эксперименты являются дорогостоящими и трудоемкими, и не все клетки и ткани поддаются высокопроизводительному транскриптомическому скринингу.

Для прогнозирования возмущений лекарственных средств было разработано несколько методов, большинство из которых являются вариациями архитектуры автокодирования (Dr.VAE, scGEN и ChemCPA). Однако этим методам не хватает надлежащих эталонных наборов данных с различными типами ячеек для определения того, насколько хорошо они обобщаются. 

Хотя **невозможно** измерить все возмущения во всех клетках, мы предполагаем, что **можно измерить подмножество** комбинаций и вывести остальное. Сегодня мы далеки от этой цели, но мы надеемся, что это соревнование послужит важным доказательством концепции.

## Ипользуемая метрика

[к содержанию](#содержание)

Mean Rowwise Root Mean Squared Error: $MRRMSE = \displaystyle \frac{1}{R} \sum_{i=1}^{R} \Big( {\frac{1}{n} \sum_{j=1}^{n} (y_{ij} - \hat{y_{ij}})^2} \bigg)^\frac{1}{2}$

где $R$ - количество набранных строк, $y_{ij}$ и $\hat y_{ij}$ реальное и предсказанное значение, соответственно, для строки $i$, столбца $j$, и $n$ - число столбцов.

## Критерии оценки

[к содержанию](#содержание)

1. Интеграция биологических знаний

2. Изучение проблемы

3. Конструкция модели (не следует затачивать модель на тестовый сет)

4. Надежность (как отреагирует модель на уменьшение тренровочных данных и/или добавление шума к данным)

5. Стиль документации и кода

6. Воспроизводимость

***
***

## Обзор данных

[к содержанию](#содержание)

>**`de_train.parquet`** - Агрегированные данные дифференциального выражения в плотном формате массива:

* гены `A1BG`, `A1BG-AS1`, ..., `ZZEF1` (всего 18211) - значение дифференциального выражения $(-log10(p-value)*sign(LFC))$ для каждого гена.

* `cell_type` - Аннотированный клеточный тип для каждой клетки на основе РНК-выражения

* `sm_name` - Основное имя (родительского) соединения (в стандартизированном представлении), выбранного `LINCS`. Это сделано для того, чтобы сопоставить данные, полученные в ходе этого эксперимента, с данными карты подключения [LINCS](https://lincsportal.ccs.miami.edu/datasets/view/LDS-1611).

* `sm_lincs_id` - Глобальное `LINCS ID` (родительское, в стандартизированном представлении). Это сделано для того, чтобы сопоставить данные, полученные в ходе этого эксперимента, с данными карты подключения [LINCS](https://lincsportal.ccs.miami.edu/datasets/view/LDS-1611).

* `SMILES` - Упрощенная молекулярно-входная система ввода [SMILES](https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system) представлений соединений, используемых в эксперименте. Это 1D представление молекулярной структуры. Эти `SMILES` предоставляются `Cellarity` на основе специфических соединений, заказанных для этого эксперимента.

* `control` - Логический флаг, указывающий, использовался ли этот экземпляр в качестве элемента управления.

* * Файл `de_train.parquet` содержит основные данные проект. Он содержит значения для ряда пар `cell_type / sm_name`.

* * Примечание: нет данных `DE` для образца `DMSO`, потому что это отрицательный контроль. Все данные `DE` рассчитан по отношению к `DMSO`, т.е. анализ `DE` спрашивает "насколько я уверен, что каждый ген увеличенный или уменьшенный относится к `DMSO` в сложной обработке".

>**`adata_train.parquet`** - Неупорядоченный подсчет и нормализованные данные в формате `COO Sparse-Array`. Дополнение к `de_train`. В дополнение к полям в `de_train`, эти данные также имеют:

* `obs_id` - Уникальный идентификатор, присваиваемый каждой ячейке необработанного набора данных.

* `gene` - Соответствует колонкам `de_train`.

* `count` - Первичные молекулярные подсчеты для данных экспрессии генов, измеренных в эксперименте как выход `10x CellRanger`.

* `normalized_count` - Эти числа были нормализованы по размеру библиотеки и преобразованы в $log(X+1)$.

>**`adata_obs_meta.csv`** - Метаданные наблюдения для `adata_train`.

* `library_id` - Уникальный идентификатор для каждой библиотеки, который является измерением, выполненным на собранных образцах из каждого ряда пластины. Все клетки из колодцев на одном ряду одной пластины будут иметь общий `library_id`.

* `plate_name` - Уникальный идентификатор для всех образцов с одной пластины.

* `well` - Расположение образца на каждой пластине (это стандартное в 96 экспериментах на пластине). **Это конкатенация ряда и кола.**

* `row` - Из какой строки был взят образец.

* `col` - Из какого столбца был взят образец.

* `donor_id` - Идентификатор донора образца, один из трех.

* `cell_type` - Аннотированный тип ячеек каждой ячейки, основанный на РНК-выражении. Это соответствует `cell_type` в `de_train.parquet`.

* `cell_id` - Это включено для **согласованности** с метаданными `LINCS Connectivity Map`, которые обозначают `cell_id` для каждой клеточной линии.

* `sm_name` - основное имя (родительского) соединения (в стандартизированном представлении), выбранного `LINCS`. Это сделано для того, чтобы сопоставить данные, полученные в ходе этого эксперимента, с данными карты [LINCS](https://lincsportal.ccs.miami.edu/datasets/view/LDS-1611).

* `sm_lincs_id` - Глобальное соединение `LINCS ID` (родительское) (в стандартизированном представлении). Это сделано для того, чтобы сопоставить данные, полученные в ходе этого эксперимента, с данными карты [LINCS](https://lincsportal.ccs.miami.edu/datasets/view/LDS-1611).

* `SMILES` - упрощенная молекулярно-входная система ввода [SMILES](https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system) представлений соединений, используемых в эксперименте. Это 1D представление молекулярной структуры. Эти `SMILES` предоставляются `Cellarity` на основе специфических соединений, заказанных для этого эксперимента.

* `dose_uM` - Доза соединения в микромолярном масштабе. Это отображает поле `pert_idose` в `LINCS`.

* `timepoint_hr` - Продолжительность лечения в часах. Это отображает поле `pert_itime` в `LINCS`.

* `control` - Логический флаг, указывающий, использовался ли этот экземпляр в качестве элемента управления.

>**`multiome_train.parquet`** - Это дополнительные 10-кратные многомерные данные для каждого образца на базовом уровне.

* `obs_id` - уникальный идентификатор для каждого наблюдения. (**Отличается от идентификаторов, используемых в `adata_train`.**)

* `location` - Это идентификатор признака. Если `feature_type` в `multiome_var_meta.csv` является `Gene Expression`, то это символ гена. Если `feature_type` является `Peaks`, то это геномный интервал пика.

* `count` - это первичные молекулярные подсчеты транскрипта для доступного измерения ДНК как выход [Cellranger-Arc](https://support.10xgenomics.com/single-cell-multiome-atac-gex/software/pipelines/latest/output/overview).

* `normalized_count` - Если `feature_type` в `multiome_var_meta.csv` является `Gene Expression`, то это нормализованный и логарифмированный $log(X+1)$ подсчет. Если `feature_type` является `Peaks`, то это пиковое число `ATAC-seq`, преобразованное с помощью [TF-IDF](https://muon.readthedocs.io/en/latest/api/generated/muon.atac.pp.tfidf.html?highlight=tfidf) преобразованный $log(TF) * log(IDF)$

>**`multiome_obs_meta.csv`** 

* `obs_id` - уникальный идентификатор для каждого наблюдения, совпадает с `obs_id` в `multiome_train.parquet`. (**Отличается от идентификаторов, используемых в `adata_train`.**)

* `cell_type` - Аннотированный клеточный тип для каждой клетки на основе РНК-выражения.

* `donor_id` - Идентификатор донора образца, один из трех.

>**`multiome_var_meta.csv`** 

* `location` - Это идентификатор признака. Если `feature_type` в `multiome_var_meta.csv` является `Gene Expression`, то это символ гена. Если `feature_type` является `Peaks`, то это геномный интервал пика.

* `gene_id` - Это альтернативный уникальный идентификатор признака. Если `feature_type` является `Gene Expression`, то это `Ensembl Stable Gene ID`. Если `feature_type` является `Peaks`, то это геномный интервал пика.

* `feature_type` - Обозначает, является ли признак измерением экспрессии РНК или измерением `Chromatin Accessibility`.

* `genome` - версия генома, используемая при запуске `CellRanger-Arc`.

* `interval` - геномные координаты каждой функции на эталонном геноме `GRCh38`. Геномные координаты напрямую связаны с эталонным геномом и включают имя хромосомы, начальное положение и конечное положение в следующем формате: `chr1:1234570-1234870`.


>**`id_map.csv`** - Определяет пару `cell_type / sm_name`, которая должна быть предсказана для данного `id`.

## Submission file

    **`sample_submission.csv`** - Образеец файла `submission` в правильном формат

Для каждого `id` в тестовом сете необходимо предсказать значение для каждого из `18211` генов, представленных в отдельных столбцах. Каждый `id` соответствует паре `cell_type / sm_name`, которые находятся в файле `id_map.csv`.


## Описание данных

[к содержанию](#содержание)

Для этого конкурса организаторы разработали и создали новый набор данных одноклеточных возмущений в периферических моноядерных клетках крови человека (`PBMCs`). Организаторы отобрали 144 соединения из Библиотеки интегрированных сетевых клеточных сигнатур (`LINCS`),карта связи (`PMID: 29195078`) и измерили профили экспрессии одноклеточных генов после 24 часов лечения. Эксперимент был повторен у трех здоровых человеческих доноров, и соединения были выбраны на основе различных транскрипционных сигнатур, наблюдаемых в гемопоэтических стволовых клетках `CD34+`.

### Технические подробности об эксперименте

Для понимания набора данных важно знать конструкцию пластин, используемых для измерения эффекта обработки. `PBMCs` доноров разморозили и покрыли на 96 углубления в плитах. Две колонны пластин были посвящены положительным элементам управления (`dabrfenib` и `belinostat`) и одна колонка была посвящена отрицательному контролю (`DMSO`). Положительные элементы управления были выбраны потому, что они, как правило, оказывают большое влияние на транскрипцию, и отрицательный контроль используется в качестве растворителя для соединений, используемых в этом исследовании. Оставшиеся скважины на плите распределены по 72 соединениям. Полный набор данных содержит 2 разные составные пластины на донора, всего 6 пластин.

![Experimental setup](blood.png)

Обратите внимание, каждый колодец содержит `PBMCs`, которые представляют собой набор различных типов ячеек. К ним относятся `Т`-клетки, `В`-клетки, `NK`-клетки и миелоидные клетки, такие как макрофаги и моноциты. Основываясь на данных о экспрессии генов, измеренных в `scRNA`, мы можем вычислительно назначить каждую клетку типу клетки. Обратите внимание, что, поскольку мы измеряем только ~350 клеток в скважине и поскольку соединения могут оказывать токсическое воздействие на некоторые типы клеток, мы не всегда наблюдаем каждый тип клеток в каждом колодце.

Другой технической переменной, которая повлияет на исходные данные в этом эксперименте, является химическая маркировка каждой скважины в каждом ряду пластины, а затем объединение всех образцов в каждой строке в единый пул для секвенирования. Это называется `Cell Multiplexing`, и вы можете прочитать больше об этом на сайте `10x Genomics` [What is Cell Multiplexing?](https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/what-is-cellplex) Вам нужно знать, что это создает некоторую техническую погрешность, связывающую все скважины в каждом ряду пластины. Одна из целей включения двух положительных элементов управления и одного отрицательного элемента управления в каждый ряд пластины - это позволить нам учитывать этот источник шума при вычислении дифференциального выражения.

### Как мы вычисляем дифференциальное выражение

В этом конкурсе участникам поручается моделирование дифференциальной экспрессии (`DE`), что позволяет оценить влияние экспериментального возмущения на уровень экспрессии каждого гена в транскрипции (18211 генов в этом наборе данных). Мы оцениваем влияние каждого соединения, сначала усредняя количество экспрессии сырых генов в каждой клетке конкретного типа в каждом образце, которое в одноклеточной литературе называется псевдобулкингом. Затем мы подгоняем линейную модель к псевдосвободным данным подсчета с использованием Лиммы и включаем библиотеку (строку), пластину и донора в качестве технических ковариатов и соединения в качестве экспериментального ковариата.

Ниже приводится схема этого процесса:

![Differential expression analysis](de_blood.png)

    Что такое дифференциальное выражение
    Из [Энциклопедии биоинформатики и вычислительной биологии:](https://www.sciencedirect.com/referencework/9780128114322/encyclopedia-of-bioinformatics-and-computational-biology) Дифференциальная экспрессия генов, обычно сокращённая как `DG` или `DGE`-анализ, относится к анализу и интерпретации различий в обилии транскриптомов генов в транскриптоме (`Conesa et al., 2016`). Списки генов, которые отличаются от двух наборов образцов, часто обеспечиваются инструментами анализа данных RNA-seq или могут быть получены вручную путем статистического тестирования наборов данных. Из-за большого количества генов, подлежащих тестированию (например, > 20000 в геноме человека), обычно применяется множественная коррекция тестирования, такая как коррекция Бонферрони.
    Для того, чтобы узнать больше, мы предлагаем начать здесь: [Одноклеточный анализ экспрессии генов.](https://www.sc-best-practices.org/conditions/differential_gene_expression.html)

Результатом этой модели является предполагаемое складчатое изменение экспрессии генов и множественное тестирование исправленного `p-value`, что экспрессия данного гена зависит от сложной экспериментальной переменной. В мире дифференциальных тестов есть длинная кроличья нора. У нас нет полной механистической модели генеративного процесса сбора данных `scRNA`, и многие группы расходятся во мнениях о том, как лучше всего учитывать переменные, вызывающие беспокойство, или технический шум. Мы выбрали лимму, потому что она хорошо работает в нашем тестировании.

Обратите внимание, существует возможность утечки конфиденциальности из тестового набора, если мы опубликуем данные первичного учета и дифференциальный анализ экспрессии, рассчитанные на всех образцах. Для защиты от этого мы дважды подходим к модели дифференциального выражения. Для создания тренировочных данных модель `DE` подходит только для образцов из тренировочного набора. Для генерации частных и общедоступных тестовых данных модель `DE` подходит для всех образцов в эксперименте. Это сохраняет данные теста в тайне и гарантирует, что данные теста будут наиболее точными.

### Разбивка данных

Ваша задача - предсказать значения дифференциальной экспрессии для миелоидных и `В`-клеток для большинства соединений. Вы будете тренировать свою модель на данных из всех 144 соединений в `Т`-клетках (`CD4+`, `CD8+`, регуляторных) и `NK`-клетках и 10% соединений в миелоидных и `В`-клетках. Это зеркально отражает научный контекст, в котором можно делать предсказания в новых типах клеток, принимая только `1/10` части измерений в этом типе клеток.

Train:

- Все соединения в Т, клетках НК

- 15 соединений + положительный и отрицательный контроль в В и миелоидных клетках

Public test:

- 50 случайно выбранных соединений в `В`-клетках и миелоидных клетках

Privat test:

- 79 случайно выбранных соединений в `В`-клетках и миелоидных клетках

Таким образом, распределение  `train / test split` по типам ячеек выглядит следующим образом:

![Train test split](train_test_split.png)

Обратите внимание, что нет никаких дополнительных тестовых данных кроме указанных пар `cell_type / sm_name`. Входом в вашу модель будет кортеж `cell_type` и `sm_name`, а выход вашей модели будет предсказан подписанным $signed -log10(p-values)$ для всех 18211 генов.

## Итоги

[к содержанию](#содержание)